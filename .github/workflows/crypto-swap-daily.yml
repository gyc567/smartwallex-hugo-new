name: 加密货币合约日报

on:
  schedule:
    # 每日北京时间05:00 (UTC 21:00) 运行
    - cron: '0 21 * * *'
  workflow_dispatch: # 允许手动触发
    inputs:
      force_run:
        description: '强制运行（忽略最近运行检查）'
        required: false
        default: 'false'

jobs:
  crypto-swap-daily:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # 需要写权限以提交生成的文章
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: 设置 Python 环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: 安装依赖
      run: |
        cd scripts
        pip install -r requirements.txt

    - name: 配置 Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: 运行加密货币合约分析
      run: |
        cd scripts
        echo "🚀 开始执行加密货币合约日报分析任务..."
        python crypto_swap_analyzer.py
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTIONS: 'true'

    - name: 检查文件变更
      id: check-changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "📝 检测到新文件生成"
          git status --short
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "📭 没有新文件生成"
        fi

    - name: 提交并推送变更
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "📝 提交新生成的文章..."
        git add content/posts/*.md || true
        git add data/ || true
        
        # 生成提交消息
        CURRENT_DATE=$(date '+%Y-%m-%d')
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        cat > /tmp/commit_msg << 'EOF'
        feat(crypto-swap): ${CURRENT_DATE} 加密货币合约日报

        自动生成的加密货币合约分析文章
        分析币种: BTC, ETH, BNB, SOL, BCH
        执行时间: ${CURRENT_TIME}

        Generated with Claude Code

        Co-Authored-By: Claude <noreply@anthropic.com>
        EOF
        
        # 替换变量并提交
        sed -i "s/\${CURRENT_DATE}/$CURRENT_DATE/g" /tmp/commit_msg
        sed -i "s/\${CURRENT_TIME}/$CURRENT_TIME/g" /tmp/commit_msg
        git commit -F /tmp/commit_msg
        git push origin main
        echo "✅ 成功推送到远程仓库"

    - name: 分析结果摘要
      if: always()
      run: |
        echo "## 📊 加密货币合约日报执行摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- 🗓️ **执行时间**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- 💰 **分析币种**: BTC, ETH, BNB, SOL, BCH" >> $GITHUB_STEP_SUMMARY
        echo "- 🎯 **分析类型**: 永续合约交易信号" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.check-changes.outputs.changes }}" == "true" ]]; then
          echo "- ✅ **状态**: 成功生成新文章" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 **新文章**: 已添加到 content/posts/" >> $GITHUB_STEP_SUMMARY
        else
          echo "- 📭 **状态**: 未生成新文章" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📂 仓库文件变更" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        git status --porcelain || echo "无文件变更"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY