name: LookOnChain 每日分析

on:
  schedule:
    # 每日北京时间18:00 (UTC 10:00) 运行
    - cron: '0 10 * * *'
    # 每日北京时间午夜0:00 (UTC 16:00) 运行 
    - cron: '0 16 * * *'
  workflow_dispatch: # 允许手动触发
    inputs:
      force_run:
        description: '强制运行（忽略最近运行检查）'
        required: false
        default: 'false'

jobs:
  lookonchain-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # 需要写权限以提交生成的文章
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: 设置 Python 环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: 安装依赖
      run: |
        cd scripts
        pip install -r requirements.txt

    - name: 配置 Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: 运行 LookOnChain 分析
      run: |
        cd scripts
        echo "🚀 开始执行 LookOnChain 分析任务..."
        python lookonchain_analyzer.py
      env:
        GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTIONS: 'true'

    - name: 检查文件变更
      id: check-changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "📝 检测到新文件生成"
          git status --short
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "📭 没有新文件生成"
        fi

    - name: 提交并推送变更
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "📝 提交新生成的文章..."
        git add content/posts/*.md || true
        git add data/ || true
        
        # 生成提交消息
        CURRENT_DATE=$(date '+%Y-%m-%d')
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        cat > /tmp/commit_msg << 'EOF'
        feat(lookonchain): ${CURRENT_DATE} LookOnChain每日分析

        自动生成的LookOnChain文章分析
        执行时间: ${CURRENT_TIME}
        数据来源: https://www.lookonchain.com

        Generated with Claude Code

        Co-Authored-By: Claude <noreply@anthropic.com>
        EOF
        
        # 替换变量并提交
        sed -i "s/\${CURRENT_DATE}/$CURRENT_DATE/g" /tmp/commit_msg
        sed -i "s/\${CURRENT_TIME}/$CURRENT_TIME/g" /tmp/commit_msg
        git commit -F /tmp/commit_msg
        git push origin main
        echo "✅ 成功推送到远程仓库"

    - name: 分析结果摘要
      if: always()
      run: |
        echo "## 📊 LookOnChain 分析执行摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- 🗓️ **执行时间**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- 🌐 **数据源**: https://www.lookonchain.com" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.check-changes.outputs.changes }}" == "true" ]]; then
          echo "- ✅ **状态**: 成功生成新文章" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 **新文章**: 已添加到 content/posts/" >> $GITHUB_STEP_SUMMARY
        else
          echo "- 📭 **状态**: 未生成新文章" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📂 仓库文件变更" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        git status --porcelain || echo "无文件变更"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY