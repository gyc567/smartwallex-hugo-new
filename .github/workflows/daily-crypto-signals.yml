name: Daily Crypto Trading Signals

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´21:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´05:00ï¼‰- é€‚åˆäºšæ´²å¸‚åœºäº¤æ˜“æ—¶æ®µ
    - cron: '0 21 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      test_mode:
        description: 'Test mode (send to test channel instead of production)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  generate-and-send-signals:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™ä»“åº“å†…å®¹
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      timeout-minutes: 10
      run: |
        echo "ğŸ“¦ å®‰è£… Python ä¾èµ–..."
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: Check Python syntax
      run: |
        echo "ğŸ” æ£€æŸ¥Pythonè¯­æ³•..."
        python scripts/check-syntax.py
        echo "ğŸ” æ£€æŸ¥Telegram senderè¯­æ³•..."
        python -m py_compile scripts/telegram_sender.py

    - name: Run Telegram sender tests
      run: |
        echo "ğŸ§ª è¿è¡ŒTelegram senderæµ‹è¯•..."
        python scripts/test_telegram_sender.py
        echo "âœ… Telegram senderæµ‹è¯•é€šè¿‡"

    - name: Test Telegram connection
      id: telegram_test
      continue-on-error: true
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ github.event.inputs.test_mode == 'true' && secrets.TELEGRAM_TEST_CHANNEL_ID || secrets.TELEGRAM_CHANNEL_ID }}
      run: |
        echo "ğŸ”— æµ‹è¯•Telegramè¿æ¥..."
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHANNEL_ID" ]; then
          python scripts/telegram_sender.py --token "$TELEGRAM_BOT_TOKEN" --channel "$TELEGRAM_CHANNEL_ID" --message "ğŸ§ª Connection test" --test
          echo "telegram_connected=true" >> $GITHUB_OUTPUT
          echo "âœ… Telegramè¿æ¥æˆåŠŸ"
        else
          echo "telegram_connected=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Telegramé…ç½®æœªè®¾ç½®ï¼Œè·³è¿‡å‘é€"
        fi

    - name: Generate trading signals
      id: signals
      timeout-minutes: 30
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTIONS: true
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      run: |
        echo "ğŸš€ å¼€å§‹ç”ŸæˆAIé©±åŠ¨çš„åŠ å¯†è´§å¸äº¤æ˜“ä¿¡å·..."
        cd ${{ github.workspace }}
        
        # ä½¿ç”¨æ–°çš„AIäº¤æ˜“ä¿¡å·ç”Ÿæˆå™¨åŒ…è£…å™¨
        python scripts/trading_signal_generator_wrapper.py \
          --count 3 \
          --output signals.json \
          --include-summary \
          --use-ai
        
        if [ $? -eq 0 ]; then
          echo "âœ… äº¤æ˜“ä¿¡å·ç”Ÿæˆå®Œæˆ"
          SIGNALS_COUNT=$(python -c "import json; print(len(json.load(open('signals.json'))['signals']))")
          echo "signals_generated=true" >> $GITHUB_OUTPUT
          echo "signals_count=$SIGNALS_COUNT" >> $GITHUB_OUTPUT
        else
          echo "âŒ äº¤æ˜“ä¿¡å·ç”Ÿæˆå¤±è´¥"
          echo "signals_generated=false" >> $GITHUB_OUTPUT
          echo "signals_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Send signals to Telegram
      id: telegram_send
      if: steps.telegram_test.outputs.telegram_connected == 'true' && steps.signals.outputs.signals_generated == 'true'
      continue-on-error: true
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ github.event.inputs.test_mode == 'true' && secrets.TELEGRAM_TEST_CHANNEL_ID || secrets.TELEGRAM_CHANNEL_ID }}
      run: |
        echo "ğŸ“¤ å‘é€äº¤æ˜“ä¿¡å·åˆ°Telegram..."
        
        # åˆ›å»ºå‘é€è„šæœ¬
        cat > send_signals.py << 'EOF'
        import json
        import sys
        sys.path.append('scripts')
        from telegram_sender import TelegramSender
        
        def main():
            sender = TelegramSender(sys.argv[1], sys.argv[2])
            
            # å‘é€æ¯æ—¥æ±‡æ€»
            with open('signals.json', 'r') as f:
                data = json.load(f)
            
            # é˜²å¾¡æ€§ç¼–ç¨‹ï¼šå®‰å…¨è·å–å­—æ®µ
            market_summary = data.get('market_summary', {})
            date = market_summary.get('date', 'Unknown')
            time = market_summary.get('time', 'Unknown')
            market_sentiment = market_summary.get('market_sentiment', 'Neutral')
            signals_count = len(data.get('signals', []))
            
            summary = f"""ğŸ“Š <b>SmartWallex Daily Trading Signals</b>
        
        ğŸ—“ï¸ <b>Date:</b> {date}
        â° <b>Time:</b> {time}
        ğŸ“ˆ <b>Signals Generated:</b> {signals_count}
        ğŸ¯ <b>Market Sentiment:</b> {market_sentiment}"""
            
            success = sender.send_message(summary)
            if not success:
                return False
            
            # å‘é€æ¯ä¸ªä¿¡å·
            signals_sent = 0
            for signal in data.get('signals', []):
                if sender.send_trading_signal(signal):
                    signals_sent += 1
            
            print(f"telegram_signals_sent={signals_sent}")
            # Write to file for GitHub Actions
            with open('telegram_signals_sent.txt', 'w') as f:
                f.write(str(signals_sent))
            return signals_sent > 0
        
        if __name__ == '__main__':
            success = main()
            sys.exit(0 if success else 1)
        EOF
        
        # æ‰§è¡Œå‘é€
        python send_signals.py "$TELEGRAM_BOT_TOKEN" "$TELEGRAM_CHANNEL_ID"
        
        # è¯»å–ç»“æœ
        if [ -f "telegram_signals_sent.txt" ]; then
          SIGNALS_SENT=$(cat telegram_signals_sent.txt)
          echo "telegram_signals_sent=$SIGNALS_SENT" >> $GITHUB_OUTPUT
          echo "âœ… å·²å‘é€ $SIGNALS_SENT ä¸ªäº¤æ˜“ä¿¡å·åˆ°Telegram"
        else
          echo "telegram_signals_sent=0" >> $GITHUB_OUTPUT
          echo "âš ï¸ æœªå‘é€ä»»ä½•ä¿¡å·"
        fi

    - name: Save signals history
      if: steps.signals.outputs.signals_generated == 'true'
      run: |
        echo "ğŸ’¾ ä¿å­˜ä¿¡å·å†å²..."
        mkdir -p data
        
        # è¿½åŠ åˆ°å†å²æ–‡ä»¶
        if [ ! -f "data/trading_signals.json" ]; then
          echo "[]" > data/trading_signals.json
        fi
        
        python -c "
        import json
        import datetime
        
        # è¯»å–ç°æœ‰å†å²
        try:
          with open('data/trading_signals.json', 'r') as f:
            history = json.load(f)
        except:
          history = []
        
        # è¯»å–æ–°ä¿¡å·
        with open('signals.json', 'r') as f:
          signals_data = json.load(f)
        
        # è·å–ä¿¡å·åˆ—è¡¨
        new_signals = signals_data.get('signals', [])
        
        # æ·»åŠ æ—¶é—´æˆ³å’Œæ‰¹æ¬¡ä¿¡æ¯
        batch_id = datetime.datetime.utcnow().isoformat()
        for signal in new_signals:
          signal['batch_id'] = batch_id
          signal['created_at'] = datetime.datetime.utcnow().isoformat()
          history.append(signal)
        
        # ä¿æŒæœ€è¿‘1000æ¡è®°å½•
        history = history[-1000:]
        
        # ä¿å­˜
        with open('data/trading_signals.json', 'w') as f:
          json.dump(history, f, indent=2)
        
        print(f'ğŸ’¾ Saved {len(new_signals)} signals to history (total: {len(history)})')
        "

    - name: Commit signals history
      if: steps.signals.outputs.signals_generated == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # é˜²å¾¡æ€§ Git æ“ä½œï¼šåŒæ­¥è¿œç¨‹æ›´æ”¹å¹¶å¤„ç†å†²çª
        echo "ğŸ”„ åŒæ­¥è¿œç¨‹æ›´æ”¹..."
        git fetch origin main
        
        # å¦‚æœæœ¬åœ°è½åï¼Œå…ˆ rebase
        if ! git diff --quiet HEAD origin/main; then
          echo "ğŸ“¥ æ£€æµ‹åˆ°è¿œç¨‹æ›´æ”¹ï¼Œæ­£åœ¨åŒæ­¥..."
          git rebase origin/main || {
            echo "âš ï¸  Rebase å†²çªï¼Œå°è¯• reset å¹¶é‡æ–°åº”ç”¨æ›´æ”¹"
            git rebase --abort
            git reset --hard origin/main
            
            # é‡æ–°ä¿å­˜ä¿¡å·å†å²ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰
            echo "ğŸ”„ é‡æ–°åº”ç”¨ä¿¡å·å†å²æ›´æ”¹..."
            python -c "
        import json
        import datetime
        
        # è¯»å–ç°æœ‰å†å²
        try:
          with open('data/trading_signals.json', 'r') as f:
            history = json.load(f)
        except:
          history = []
        
        # è¯»å–æ–°ä¿¡å·
        with open('signals.json', 'r') as f:
          signals_data = json.load(f)
        
        # è·å–ä¿¡å·åˆ—è¡¨
        new_signals = signals_data.get('signals', [])
        
        # æ·»åŠ æ—¶é—´æˆ³å’Œæ‰¹æ¬¡ä¿¡æ¯
        batch_id = datetime.datetime.utcnow().isoformat()
        for signal in new_signals:
          signal['batch_id'] = batch_id
          signal['created_at'] = datetime.datetime.utcnow().isoformat()
          history.append(signal)
        
        # ä¿æŒæœ€è¿‘1000æ¡è®°å½•
        history = history[-1000:]
        
        # ä¿å­˜
        with open('data/trading_signals.json', 'w') as f:
          json.dump(history, f, indent=2)
        
        print(f'ğŸ”„ é‡æ–°ä¿å­˜ {len(new_signals)} ä¸ªä¿¡å·åˆ°å†å²è®°å½•')
        "
          }
        fi
        
        git add data/trading_signals.json
        if ! git diff --staged --quiet; then
          # å¸¦é‡è¯•çš„æ¨é€æœºåˆ¶
          RETRY_COUNT=0
          MAX_RETRIES=3
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¤ å°è¯•æ¨é€ (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            
            git commit -m "ğŸ¤– Auto: Trading signals $(date +%Y-%m-%d) - ${{ steps.signals.outputs.signals_count }} signals" || true
            
            if git push; then
              echo "âœ… æ¨é€æˆåŠŸï¼"
              break
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼ŒåŒæ­¥è¿œç¨‹æ›´æ”¹..."
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                git fetch origin main
                git rebase origin/main || {
                  echo "âš ï¸  Rebase å¤±è´¥ï¼Œreset å¹¶é‡è¯•..."
                  git rebase --abort
                  git reset --soft origin/main
                  git add data/trading_signals.json
                }
                sleep 2
              else
                echo "ğŸ’¥ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ¨é€å¤±è´¥"
                exit 1
              fi
            fi
          done
        else
          echo "ğŸ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        fi

    - name: Create summary
      if: always()
      run: |
        echo "## ğŸ¤– AI Daily Crypto Trading Signals Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
        echo "- **Time**: $(date -u +"%H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Analysis Type**: AI Expert Analysis" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Source**: Bitget + AI Model" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.signals.outputs.signals_generated }}" == "true" ]; then
          echo "- **AI Signals Generated**: ${{ steps.signals.outputs.signals_count }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **AI Signals Generated**: Failed or skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.telegram_test.outputs.telegram_connected }}" == "true" ]; then
          echo "- **Telegram Status**: âœ… Connected" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.telegram_send.outputs.telegram_signals_sent }}" != "" ]; then
            echo "- **Signals Sent**: ${{ steps.telegram_send.outputs.telegram_signals_sent }}" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **Telegram Status**: âš ï¸ Not configured or connection failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
          echo "- **Mode**: ğŸ§ª Test Mode" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Mode**: ğŸš€ Production Mode" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºå†å²ç»Ÿè®¡
        if [ -f "data/trading_signals.json" ]; then
          TOTAL_SIGNALS=$(python3 -c "import json; print(len(json.load(open('data/trading_signals.json'))))" 2>/dev/null || echo "0")
          echo "- **Total Historical Signals**: $TOTAL_SIGNALS" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Risk Warning" >> $GITHUB_STEP_SUMMARY
        echo "Trading involves substantial risk. Past performance does not guarantee future results. Only invest what you can afford to lose." >> $GITHUB_STEP_SUMMARY